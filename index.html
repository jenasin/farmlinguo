<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FarmLinguo - Jifunze Kilimo</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#16a34a">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: linear-gradient(to bottom, #f0fdf4, #dcfce7); min-height: 100vh; }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: flex; flex-direction: column; }
        .btn { padding: 18px 24px; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin: 8px 0; }
        .btn-green { background: #16a34a; color: white; box-shadow: 0 4px 0 #166534; }
        .btn-green:active { transform: translateY(2px); box-shadow: 0 2px 0 #166534; }
        .btn-answer { background: white; border: 2px solid #e5e7eb; text-align: left; display: flex; align-items: center; gap: 12px; }
        .btn-answer.correct { background: #dcfce7; border-color: #16a34a; }
        .btn-answer.wrong { background: #fee2e2; border-color: #dc2626; }
        .header { background: #16a34a; color: white; padding: 16px; }
        .card { background: white; border-radius: 20px; padding: 24px; margin: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        input[type="text"] { width: 100%; padding: 16px; font-size: 18px; border: 2px solid #e5e7eb; border-radius: 12px; }
        .timer { font-size: 32px; font-weight: bold; font-family: monospace; }
        .progress { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: #16a34a; transition: width 0.3s; }
        .icon { font-size: 48px; }
        .module-btn { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; display: flex; align-items: center; gap: 16px; }
        .module-btn.locked { background: linear-gradient(135deg, #86efac, #4ade80); opacity: 0.6; cursor: not-allowed; }
        .module-btn.completed { background: linear-gradient(135deg, #16a34a, #15803d); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px 0; }
        .stat-box { background: #f0f9ff; padding: 16px; border-radius: 12px; text-align: center; }
        .stat-num { font-size: 24px; font-weight: bold; color: #0369a1; }
        .participant { background: white; padding: 16px; border-radius: 12px; margin: 8px 16px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #16a34a; }
    </style>
</head>
<body>
    <!-- START SCREEN -->
    <div id="startScreen" class="screen active">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; padding:24px;">
            <div style="text-align:center; margin-bottom:32px;">
                <div class="icon">üå±</div>
                <h1 style="color:#16a34a; font-size:32px;">FarmLinguo</h1>
                <p style="color:#666;">Jifunze Kilimo kwa Kiswahili</p>
            </div>
            <div class="card">
                <label style="font-weight:bold; display:block; margin-bottom:12px;">üë§ Jina lako:</label>
                <input type="text" id="nameInput" placeholder="Andika jina hapa...">
            </div>
            <div style="padding:0 16px;">
                <button class="btn btn-green" onclick="startTest()">üöÄ Anza Mtihani</button>
                <p style="text-align:center; color:#888; margin-top:12px;">‚è±Ô∏è Dakika 5 ‚Ä¢ üìö Moduli 5</p>
            </div>
            <div style="padding:16px;">
                <button class="btn" style="background:#dbeafe; color:#1d4ed8;" onclick="showParticipants()">
                    üë• Washiriki (<span id="participantCount">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- MODULES SCREEN -->
    <div id="modulesScreen" class="screen">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold;" id="displayName">Mkulima</div>
                    <div style="font-size:14px; opacity:0.8;"><span id="answeredCount">0</span> maswali</div>
                </div>
                <div style="text-align:right;">
                    <div class="timer" id="timerDisplay">5:00</div>
                    <div style="font-size:12px; opacity:0.8;">zimebaki</div>
                </div>
            </div>
            <div class="progress" style="margin-top:12px;">
                <div class="progress-bar" id="timeProgress" style="width:0%"></div>
            </div>
        </div>
        <div style="flex:1; padding:16px; overflow-y:auto;">
            <h2 style="text-align:center; margin-bottom:16px; color:#333;">Chagua Kiwango</h2>
            <div id="modulesContainer"></div>
        </div>
        <div style="padding:16px;">
            <button class="btn" style="background:#fee2e2; color:#dc2626;" onclick="endTest()">üõë Maliza Mtihani</button>
        </div>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="quizScreen" class="screen">
        <div class="header" id="quizHeader">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <button onclick="renderModules(); showScreen('modulesScreen')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">‚úï</button>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="moduleIcon">ü´ò</span>
                    <span style="font-weight:bold;">L<span id="levelNum">1</span></span>
                </div>
                <div class="timer" id="quizTimer" style="font-size:24px;">5:00</div>
            </div>
            <div class="progress">
                <div class="progress-bar" id="questionProgress" style="width:20%"></div>
            </div>
        </div>
        <div style="flex:1; padding:16px; overflow-y:auto;">
            <div class="card">
                <div style="display:flex; gap:12px; align-items:flex-start;">
                    <span id="questionIcon" style="font-size:32px;">ü´ò</span>
                    <h2 id="questionText" style="font-size:20px; color:#333; flex:1;"></h2>
                </div>
            </div>
            <div id="answersContainer" style="padding:0 16px;"></div>
        </div>
        <div id="feedbackPanel" style="display:none; padding:20px; border-radius:20px 20px 0 0;">
            <div style="display:flex; gap:12px; align-items:flex-start; margin-bottom:16px;">
                <span id="feedbackIcon" style="font-size:40px;">üéâ</span>
                <div>
                    <div id="feedbackTitle" style="font-size:20px; font-weight:bold;"></div>
                    <div id="feedbackText" style="color:#666; margin-top:4px;"></div>
                </div>
            </div>
            <button id="continueBtn" class="btn btn-green" onclick="nextQuestion()">‚Üí Endelea</button>
        </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div id="resultsScreen" class="screen">
        <div id="resultsHeader" style="padding:32px; text-align:center; color:white;">
            <div id="resultEmoji" style="font-size:64px;">üèÜ</div>
            <div id="resultPercent" style="font-size:56px; font-weight:bold;">0%</div>
            <div id="resultText">0/0 sahihi</div>
        </div>
        <div style="flex:1; padding:16px;">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-num" id="statQuestions">0</div>
                    <div style="color:#666; font-size:12px;">Maswali</div>
                </div>
                <div class="stat-box" style="background:#f0fdf4;">
                    <div class="stat-num" style="color:#16a34a;" id="statCorrect">0</div>
                    <div style="color:#666; font-size:12px;">Sahihi</div>
                </div>
                <div class="stat-box" style="background:#fef3c7;">
                    <div class="stat-num" style="color:#d97706;" id="statTime">0s</div>
                    <div style="color:#666; font-size:12px;">Wastani</div>
                </div>
            </div>
        </div>
        <div style="padding:16px;">
            <button class="btn btn-green" onclick="location.reload()">üöÄ Mtihani Mpya</button>
            <button class="btn" style="background:#dbeafe; color:#1d4ed8;" onclick="showParticipants()">üë• Washiriki Wote</button>
        </div>
    </div>

    <!-- PARTICIPANTS SCREEN -->
    <div id="participantsScreen" class="screen">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="showScreen('startScreen')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">‚Üê</button>
                <h1>üë• Washiriki</h1>
                <div></div>
            </div>
        </div>
        <div style="padding:16px; display:flex; gap:8px;">
            <button class="btn" style="flex:1; background:#dcfce7; color:#16a34a;" onclick="exportJSON()">üì• JSON</button>
            <button class="btn" style="flex:1; background:#dbeafe; color:#1d4ed8;" onclick="exportCSV()">üìä CSV</button>
            <button class="btn" style="background:#fee2e2; color:#dc2626; padding:18px 16px;" onclick="clearData()">üóëÔ∏è</button>
        </div>
        <div id="participantsList" style="flex:1; overflow-y:auto;"></div>
    </div>

    <!-- QUESTION DATA -->
    <script src="questions/sw/questions_beans.js"></script>
    <script src="questions/sw/questions_cashew.js"></script>
    <script src="questions/sw/questions_drought.js"></script>
    <script src="questions/sw/questions_maize.js"></script>
    <script src="questions/sw/questions_tomato.js"></script>

    <script>
        // ========== STATE ==========
        let userName = '';
        let sessionStart = null;
        let timerInterval = null;
        let currentModule = null;
        let currentLevel = 1;
        let questions = [];
        let questionIndex = 0;
        let questionStart = null;
        let answers = [];
        let totalCorrect = 0;
        const SESSION_DURATION = 5 * 60;

        // Progress tracking - which levels are unlocked
        let unlockedIndex = 0; // Index into LEVELS array

        const LEVELS = [
            { module: 'beans', level: 1, name: 'Maharagwe', icon: 'ü´ò', color: '#f59e0b' },
            { module: 'beans', level: 2, name: 'Maharagwe', icon: 'ü´ò', color: '#f59e0b' },
            { module: 'beans', level: 3, name: 'Maharagwe', icon: 'ü´ò', color: '#f59e0b' },
            { module: 'cashew', level: 1, name: 'Korosho', icon: 'ü•ú', color: '#eab308' },
            { module: 'cashew', level: 2, name: 'Korosho', icon: 'ü•ú', color: '#eab308' },
            { module: 'cashew', level: 3, name: 'Korosho', icon: 'ü•ú', color: '#eab308' },
            { module: 'drought', level: 1, name: 'Ukame', icon: 'üèúÔ∏è', color: '#f97316' },
            { module: 'drought', level: 2, name: 'Ukame', icon: 'üèúÔ∏è', color: '#f97316' },
            { module: 'drought', level: 3, name: 'Ukame', icon: 'üèúÔ∏è', color: '#f97316' },
            { module: 'maize', level: 1, name: 'Mahindi', icon: 'üåΩ', color: '#facc15' },
            { module: 'maize', level: 2, name: 'Mahindi', icon: 'üåΩ', color: '#facc15' },
            { module: 'maize', level: 3, name: 'Mahindi', icon: 'üåΩ', color: '#facc15' },
            { module: 'tomato', level: 1, name: 'Nyanya', icon: 'üçÖ', color: '#ef4444' },
            { module: 'tomato', level: 2, name: 'Nyanya', icon: 'üçÖ', color: '#ef4444' },
            { module: 'tomato', level: 3, name: 'Nyanya', icon: 'üçÖ', color: '#ef4444' }
        ];

        // ========== HELPERS ==========
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return m + ':' + (s < 10 ? '0' : '') + s;
        }

        function getParticipants() {
            try { return JSON.parse(localStorage.getItem('farmlinguo_participants') || '[]'); }
            catch(e) { return []; }
        }

        function saveParticipants(list) {
            localStorage.setItem('farmlinguo_participants', JSON.stringify(list));
        }

        function updateParticipantCount() {
            document.getElementById('participantCount').textContent = getParticipants().length;
        }

        // ========== RENDER MODULES ==========
        function renderModules() {
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '';

            LEVELS.forEach((lvl, idx) => {
                const isCompleted = idx < unlockedIndex;
                const isUnlocked = idx === unlockedIndex;
                const isLocked = idx > unlockedIndex;

                const btn = document.createElement('button');
                btn.className = 'btn module-btn';

                if (isCompleted) {
                    btn.classList.add('completed');
                    btn.style.background = 'linear-gradient(135deg, #16a34a, #15803d)';
                } else if (isUnlocked) {
                    btn.style.background = `linear-gradient(135deg, ${lvl.color}, ${lvl.color}dd)`;
                } else {
                    btn.classList.add('locked');
                }

                const statusText = isCompleted ? '‚úì Imekamilika' : isUnlocked ? '‚ñ∂ Bofya kuanza' : 'üîí Imefungwa';

                btn.innerHTML = `
                    <span style="font-size:36px;">${lvl.icon}</span>
                    <div style="flex:1;">
                        <div style="font-size:20px;">${lvl.name} - L${lvl.level}</div>
                        <div style="font-size:14px;opacity:0.8;">${statusText}</div>
                    </div>
                `;

                if (isUnlocked) {
                    btn.onclick = () => startLevel(idx);
                } else if (isCompleted) {
                    btn.onclick = () => startLevel(idx); // Allow replay
                }

                container.appendChild(btn);
            });

            // If all completed, show congratulations
            if (unlockedIndex >= LEVELS.length) {
                const msg = document.createElement('div');
                msg.style.cssText = 'text-align:center; padding:20px; color:#16a34a; font-size:20px; font-weight:bold;';
                msg.innerHTML = 'üéâ Hongera! Umekamilisha viwango vyote!';
                container.appendChild(msg);
            }
        }

        function startLevel(idx) {
            const lvl = LEVELS[idx];
            currentModule = lvl.module;
            currentLevel = lvl.level;
            loadLevel();
        }

        // ========== TIMER ==========
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
            const remaining = Math.max(0, SESSION_DURATION - elapsed);

            document.getElementById('timerDisplay').textContent = formatTime(remaining);
            document.getElementById('quizTimer').textContent = formatTime(remaining);
            document.getElementById('timeProgress').style.width = (elapsed / SESSION_DURATION * 100) + '%';

            if (remaining <= 60) {
                document.getElementById('timerDisplay').style.color = '#fca5a5';
            }

            if (remaining <= 0) {
                endTest();
            }
        }

        // ========== START TEST ==========
        function startTest() {
            userName = document.getElementById('nameInput').value.trim();
            if (!userName) {
                alert('Tafadhali andika jina lako!');
                return;
            }

            sessionStart = Date.now();
            answers = [];
            totalCorrect = 0;
            unlockedIndex = 0; // Reset progress

            document.getElementById('displayName').textContent = userName;
            document.getElementById('answeredCount').textContent = '0';

            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();

            renderModules(); // Render level buttons
            showScreen('modulesScreen');
        }

        // ========== MODULE ==========
        function loadLevel() {
            const moduleData = {
                'beans': window.beansQuestions,
                'cashew': window.cashewQuestions,
                'drought': window.droughtQuestions,
                'maize': window.maizeQuestions,
                'tomato': window.tomatoQuestions
            };

            const icons = { 'beans': 'ü´ò', 'cashew': 'ü•ú', 'drought': 'üèúÔ∏è', 'maize': 'üåΩ', 'tomato': 'üçÖ' };

            const data = moduleData[currentModule];
            const levelKey = currentModule + '_level' + currentLevel;
            questions = data[levelKey] || [];

            if (questions.length === 0) {
                renderModules();
                showScreen('modulesScreen');
                return;
            }

            questionIndex = 0;
            document.getElementById('moduleIcon').textContent = icons[currentModule];
            document.getElementById('questionIcon').textContent = icons[currentModule];
            document.getElementById('levelNum').textContent = currentLevel;

            showQuestion();
            showScreen('quizScreen');
        }

        // ========== QUIZ ==========
        let shuffledOptions = [];

        function shuffleArray(arr) {
            const shuffled = [...arr];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showQuestion() {
            const q = questions[questionIndex];
            document.getElementById('questionText').textContent = q.question;
            document.getElementById('questionProgress').style.width = ((questionIndex + 1) / questions.length * 100) + '%';
            document.getElementById('feedbackPanel').style.display = 'none';

            const container = document.getElementById('answersContainer');
            container.innerHTML = '';

            // Shuffle options so correct answer isn't always first
            shuffledOptions = shuffleArray(q.options);

            shuffledOptions.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-answer';
                btn.innerHTML = (opt.icon ? '<span style="font-size:24px;">' + opt.icon + '</span>' : '') +
                    '<span style="flex:1;">' + opt.text + '</span>';
                btn.onclick = () => selectAnswer(i);
                container.appendChild(btn);
            });

            questionStart = Date.now();
        }

        function selectAnswer(index) {
            const q = questions[questionIndex];
            const selectedOpt = shuffledOptions[index];
            const isCorrect = selectedOpt.isCorrect;
            const responseTime = Date.now() - questionStart;

            // Record answer
            answers.push({
                module: currentModule,
                level: currentLevel,
                question: q.question,
                selected: selectedOpt.text,
                correct: shuffledOptions.find(o => o.isCorrect).text,
                isCorrect: isCorrect,
                timeMs: responseTime
            });

            if (isCorrect) totalCorrect++;
            document.getElementById('answeredCount').textContent = answers.length;

            // Show feedback
            const btns = document.querySelectorAll('#answersContainer .btn-answer');
            btns.forEach((btn, i) => {
                btn.disabled = true;
                if (shuffledOptions[i].isCorrect) btn.classList.add('correct');
                else if (i === index) btn.classList.add('wrong');
            });

            const panel = document.getElementById('feedbackPanel');
            panel.style.display = 'block';
            panel.style.background = isCorrect ? '#dcfce7' : '#fee2e2';
            document.getElementById('feedbackIcon').textContent = isCorrect ? 'üéâ' : 'üò¢';
            document.getElementById('feedbackTitle').textContent = isCorrect ? 'Vizuri sana!' : 'Si sawa kabisa';
            document.getElementById('feedbackTitle').style.color = isCorrect ? '#16a34a' : '#dc2626';
            document.getElementById('feedbackText').textContent = q.explanation || '';
            document.getElementById('continueBtn').style.background = isCorrect ? '#16a34a' : '#dc2626';
        }

        function nextQuestion() {
            questionIndex++;
            if (questionIndex >= questions.length) {
                // Level complete - unlock next level
                // Find current level index and unlock next
                const currentIdx = LEVELS.findIndex(l => l.module === currentModule && l.level === currentLevel);
                if (currentIdx >= unlockedIndex) {
                    unlockedIndex = currentIdx + 1; // Unlock next level
                }

                // Go back to modules screen to show progress
                renderModules();
                showScreen('modulesScreen');
            } else {
                showQuestion();
            }
        }

        // ========== END TEST ==========
        function endTest() {
            clearInterval(timerInterval);

            const duration = Math.floor((Date.now() - sessionStart) / 1000);
            const accuracy = answers.length > 0 ? Math.round(totalCorrect / answers.length * 100) : 0;
            const avgTime = answers.length > 0 ? Math.round(answers.reduce((a, b) => a + b.timeMs, 0) / answers.length / 1000 * 10) / 10 : 0;

            // Save participant
            const participant = {
                id: Date.now(),
                name: userName,
                date: new Date().toISOString(),
                duration: duration,
                total: answers.length,
                correct: totalCorrect,
                accuracy: accuracy,
                avgTime: avgTime,
                answers: answers
            };

            const list = getParticipants();
            list.push(participant);
            saveParticipants(list);

            // Show results
            const header = document.getElementById('resultsHeader');
            header.style.background = accuracy >= 70 ? '#16a34a' : accuracy >= 50 ? '#eab308' : '#dc2626';
            document.getElementById('resultEmoji').textContent = accuracy >= 70 ? 'üèÜ' : accuracy >= 50 ? '‚úÖ' : 'üí™';
            document.getElementById('resultPercent').textContent = accuracy + '%';
            document.getElementById('resultText').textContent = totalCorrect + '/' + answers.length + ' sahihi';
            document.getElementById('statQuestions').textContent = answers.length;
            document.getElementById('statCorrect').textContent = totalCorrect;
            document.getElementById('statTime').textContent = avgTime + 's';

            showScreen('resultsScreen');
        }

        // ========== PARTICIPANTS ==========
        function showParticipants() {
            const list = getParticipants();
            const container = document.getElementById('participantsList');

            if (list.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; padding:32px;">Hakuna washiriki bado</p>';
            } else {
                container.innerHTML = list.slice().reverse().map(p => {
                    const mins = Math.floor(p.duration / 60);
                    const secs = p.duration % 60;
                    const timeStr = mins + ':' + (secs < 10 ? '0' : '') + secs;
                    const color = p.accuracy >= 70 ? '#16a34a' : p.accuracy >= 50 ? '#eab308' : '#dc2626';
                    return '<div class="participant" style="border-left-color:' + color + '">' +
                        '<div style="flex:1;">' +
                            '<div style="font-weight:bold;">' + p.name + '</div>' +
                            '<div style="font-size:12px; color:#888;">' + new Date(p.date).toLocaleDateString() + '</div>' +
                            '<div style="font-size:13px; margin-top:4px;">‚úÖ ' + p.correct + '/' + p.total + ' ‚Ä¢ ‚è±Ô∏è ' + timeStr + '</div>' +
                        '</div>' +
                        '<div style="text-align:right;">' +
                            '<div style="font-size:24px; font-weight:bold; color:' + color + '">' + p.accuracy + '%</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            }

            showScreen('participantsScreen');
        }

        function exportJSON() {
            const data = { date: new Date().toISOString(), participants: getParticipants() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'farmlinguo_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
        }

        function exportCSV() {
            let csv = 'Jina,Tarehe,Maswali,Sahihi,Usahihi,Muda\n';
            getParticipants().forEach(p => {
                csv += '"' + p.name + '",' + p.date + ',' + p.total + ',' + p.correct + ',' + p.accuracy + '%,' + p.avgTime + 's\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'farmlinguo_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        function clearData() {
            if (confirm('Una uhakika unataka kufuta data yote?')) {
                localStorage.removeItem('farmlinguo_participants');
                updateParticipantCount();
                showParticipants();
            }
        }

        // ========== INIT ==========
        updateParticipantCount();
    </script>
</body>
</html>
