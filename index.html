<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FarmLinguo - Jifunze Kilimo</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#16a34a">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Nunito', 'Segoe UI', Tahoma, sans-serif; }
        body { background: linear-gradient(to bottom, #f0fdf4, #dcfce7); min-height: 100vh; }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: flex; flex-direction: column; }

        /* 3D Duolingo-style buttons */
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin: 6px 0;
            transition: all 0.1s ease;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-green {
            background: #58cc02;
            color: white;
            border-bottom: 4px solid #58a700;
        }
        .btn-green:hover { background: #61d802; }
        .btn-green:active {
            transform: translateY(4px);
            border-bottom-width: 0;
        }

        /* Answer buttons - Duolingo style */
        .btn-answer {
            background: white;
            border: 2px solid #e5e7eb;
            border-bottom: 4px solid #d1d5db;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            text-transform: none;
        }
        .btn-answer:hover { background: #f9fafb; border-color: #cbd5e1; }
        .btn-answer:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        .btn-answer.correct {
            background: #d7ffb8;
            border-color: #58cc02;
            border-bottom-color: #58a700;
        }
        .btn-answer.wrong {
            background: #ffdfe0;
            border-color: #ff4b4b;
            border-bottom-color: #ea2b2b;
        }

        /* Module buttons - 3D style */
        .module-btn {
            background: linear-gradient(180deg, #ffc800 0%, #ff9600 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 4px solid #cc7a00;
            text-transform: none;
        }
        .module-btn:hover { filter: brightness(1.05); }
        .module-btn:active {
            transform: translateY(4px);
            border-bottom-width: 0;
        }
        .module-btn.locked {
            background: linear-gradient(180deg, #e5e5e5 0%, #c4c4c4 100%);
            border-bottom-color: #9e9e9e;
            opacity: 0.7;
            cursor: not-allowed;
        }
        .module-btn.locked:active { transform: none; border-bottom-width: 4px; }
        .module-btn.completed {
            background: linear-gradient(180deg, #58cc02 0%, #46a302 100%);
            border-bottom-color: #2d6a00;
        }

        .header { background: #58cc02; color: white; padding: 16px; }
        .card { background: white; border-radius: 16px; padding: 24px; margin: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid #e5e7eb; }
        input[type="text"] {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            border-bottom: 4px solid #d1d5db;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #58cc02;
            border-bottom-color: #58a700;
        }
        .timer { font-size: 32px; font-weight: bold; font-family: 'Courier New', monospace; }
        .progress { height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #58cc02, #78e007); transition: width 0.3s; border-radius: 5px; }
        .icon { font-size: 48px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px 0; }
        .stat-box { background: white; padding: 16px; border-radius: 12px; text-align: center; border: 2px solid #e5e7eb; }
        .stat-num { font-size: 24px; font-weight: bold; color: #1cb0f6; }
        .participant { background: white; padding: 16px; border-radius: 12px; margin: 8px 16px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #58cc02; border: 2px solid #e5e7eb; border-left: 4px solid #58cc02; }

        /* Log items */
        .log-item { padding: 8px; border-radius: 8px; margin: 4px 0; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .log-item.correct { background: #d7ffb8; }
        .log-item.wrong { background: #ffdfe0; }
    </style>
</head>
<body>
    <!-- START SCREEN -->
    <div id="startScreen" class="screen active">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; padding:24px;">
            <div style="text-align:center; margin-bottom:32px;">
                <div class="icon">üå±</div>
                <h1 style="color:#16a34a; font-size:32px;">FarmLinguo</h1>
                <p style="color:#666;">Jifunze Kilimo kwa Kiswahili</p>
            </div>
            <div class="card">
                <label style="font-weight:bold; display:block; margin-bottom:12px;">üë§ Jina lako:</label>
                <input type="text" id="nameInput" placeholder="Andika jina hapa..." minlength="2" required>
                <div id="nameError" style="color:#ff4b4b; font-size:14px; margin-top:8px; display:none;">
                    ‚ö†Ô∏è Tafadhali andika jina lako (angalau herufi 2)
                </div>
            </div>
            <div style="padding:0 16px;">
                <button class="btn btn-green" onclick="startTest()">üöÄ ANZA MTIHANI</button>
                <p style="text-align:center; color:#888; margin-top:12px;">‚è±Ô∏è Dakika 5 ‚Ä¢ üìö Viwango 15</p>
            </div>
            <div style="padding:16px;">
                <button class="btn" style="background:#dbeafe; color:#1d4ed8;" onclick="showParticipants()">
                    üë• Washiriki (<span id="participantCount">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- MODULES SCREEN -->
    <div id="modulesScreen" class="screen">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold;" id="displayName">Mkulima</div>
                    <div style="font-size:14px; opacity:0.8;"><span id="answeredCount">0</span> maswali</div>
                </div>
                <div style="text-align:right;">
                    <div class="timer" id="timerDisplay">5:00</div>
                    <div style="font-size:12px; opacity:0.8;">zimebaki</div>
                </div>
            </div>
            <div style="margin-top:12px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                    <span>‚è±Ô∏è Muda</span>
                    <span>üìä Maendeleo: <span id="levelProgressText">0/15</span></span>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="timeProgress" style="width:0%"></div>
                </div>
                <div class="progress" style="margin-top:6px; background:#fef3c7;">
                    <div class="progress-bar" id="levelProgress" style="width:0%; background:linear-gradient(90deg, #ffc800, #ff9600);"></div>
                </div>
            </div>
        </div>
        <div style="flex:1; padding:16px; overflow-y:auto;">
            <h2 style="text-align:center; margin-bottom:8px; color:#333;">Chagua Kiwango</h2>
            <p style="text-align:center; color:#888; font-size:14px; margin-bottom:16px;">Kamilisha 80% ili kufungua kiwango kifuatacho</p>
            <div id="modulesContainer"></div>
        </div>
        <div style="padding:16px;">
            <button class="btn" style="background:#fee2e2; color:#dc2626;" onclick="endTest()">üõë Maliza Mtihani</button>
        </div>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="quizScreen" class="screen">
        <div class="header" id="quizHeader">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <button onclick="renderModules(); showScreen('modulesScreen')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">‚úï</button>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="moduleIcon">ü´ò</span>
                    <span style="font-weight:bold;">L<span id="levelNum">1</span></span>
                </div>
                <div class="timer" id="quizTimer" style="font-size:24px;">5:00</div>
            </div>
            <div class="progress">
                <div class="progress-bar" id="questionProgress" style="width:20%"></div>
            </div>
        </div>
        <div style="flex:1; padding:16px; overflow-y:auto;">
            <div class="card">
                <div style="display:flex; gap:12px; align-items:flex-start;">
                    <span id="questionIcon" style="font-size:32px;">ü´ò</span>
                    <h2 id="questionText" style="font-size:20px; color:#333; flex:1;"></h2>
                </div>
            </div>
            <div id="answersContainer" style="padding:0 16px;"></div>
        </div>
        </div>

    <!-- FEEDBACK OVERLAY -->
    <div id="feedbackOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.3); z-index:998;" onclick="nextQuestion()"></div>

    <!-- FEEDBACK POPUP (fixed bottom) -->
    <div id="feedbackPanel" style="display:none; position:fixed; bottom:0; left:0; right:0; padding:20px; padding-bottom:max(20px, env(safe-area-inset-bottom)); border-radius:20px 20px 0 0; box-shadow:0 -4px 20px rgba(0,0,0,0.3); z-index:999; background:white;">
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:16px;">
            <span id="feedbackIcon" style="font-size:48px;">üéâ</span>
            <div style="flex:1;">
                <div id="feedbackTitle" style="font-size:22px; font-weight:bold;"></div>
                <div id="feedbackText" style="color:#666; margin-top:4px; font-size:14px; max-height:60px; overflow-y:auto;"></div>
            </div>
        </div>
        <button id="continueBtn" class="btn btn-green" onclick="nextQuestion()" style="font-size:20px; padding:18px;">‚Üí ENDELEA</button>
    </div>

    <!-- RESULTS SCREEN -->
    <div id="resultsScreen" class="screen">
        <div id="resultsHeader" style="padding:32px; text-align:center; color:white;">
            <div id="resultEmoji" style="font-size:64px;">üèÜ</div>
            <div id="resultPercent" style="font-size:56px; font-weight:bold;">0%</div>
            <div id="resultText">0/0 sahihi</div>
        </div>
        <div style="flex:1; padding:16px; overflow-y:auto;">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-num" id="statQuestions">0</div>
                    <div style="color:#666; font-size:12px;">Maswali</div>
                </div>
                <div class="stat-box" style="background:#f0fdf4;">
                    <div class="stat-num" style="color:#16a34a;" id="statCorrect">0</div>
                    <div style="color:#666; font-size:12px;">Sahihi</div>
                </div>
                <div class="stat-box" style="background:#fef3c7;">
                    <div class="stat-num" style="color:#d97706;" id="statTime">0s</div>
                    <div style="color:#666; font-size:12px;">Wastani</div>
                </div>
            </div>
            <h3 style="margin:16px 0 8px; color:#333;">üìã Rekodi ya Majibu</h3>
            <div id="answersLog" style="max-height:200px; overflow-y:auto; background:#f9fafb; border-radius:12px; padding:8px;"></div>
        </div>
        <div style="padding:16px;">
            <button class="btn btn-green" onclick="location.reload()">üöÄ Mtihani Mpya</button>
            <button class="btn" style="background:#dbeafe; color:#1d4ed8;" onclick="showParticipants()">üë• Washiriki Wote</button>
        </div>
    </div>

    <!-- LEVEL COMPLETE SCREEN -->
    <div id="levelCompleteScreen" class="screen">
        <div id="levelCompleteHeader" style="padding:32px; text-align:center; color:white;">
            <div id="levelEmoji" style="font-size:64px;">üéâ</div>
            <div id="levelTitle" style="font-size:24px; font-weight:bold; margin:12px 0;">Kiwango Kimekamilika!</div>
            <div id="levelPercent" style="font-size:48px; font-weight:bold;">0%</div>
            <div id="levelScore">0/5 sahihi</div>
        </div>
        <div style="flex:1; padding:16px;">
            <div id="levelMessage" style="text-align:center; padding:20px; background:white; border-radius:16px; margin-bottom:16px;">
            </div>
        </div>
        <div style="padding:16px;">
            <button id="continueBtn2" class="btn btn-green" style="display:none;" onclick="continueToNext()">
                ‚û°Ô∏è Endelea Kiwango Kifuatacho
            </button>
            <button id="repeatBtn" class="btn" style="background:#fef3c7; color:#d97706;" onclick="repeatLevel()">
                üîÑ Rudia Kiwango Hiki
            </button>
            <button class="btn" style="background:#e5e7eb; color:#666; margin-top:8px;" onclick="renderModules(); showScreen('modulesScreen')">
                üìã Rudi kwenye Orodha
            </button>
        </div>
    </div>

    <!-- PARTICIPANTS SCREEN -->
    <div id="participantsScreen" class="screen">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="showScreen('startScreen')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">‚Üê</button>
                <h1>üë• Washiriki</h1>
                <div></div>
            </div>
        </div>
        <div style="padding:16px;">
            <div style="display:flex; gap:8px; margin-bottom:8px;">
                <button class="btn" style="flex:1; background:#dcfce7; color:#16a34a;" onclick="exportJSON()">üì• JSON</button>
                <button class="btn" style="flex:1; background:#dbeafe; color:#1d4ed8;" onclick="exportCSV()">üìä Shrnut√≠</button>
            </div>
            <button class="btn" style="background:#fef3c7; color:#d97706; width:100%;" onclick="exportDetailedCSV()">üìã Detailn√≠ CSV (vƒõdeck√° data)</button>
            <button class="btn" style="background:#fee2e2; color:#dc2626; margin-top:8px;" onclick="clearData()">üóëÔ∏è Smazat v≈°e</button>
        </div>
        <div id="participantsList" style="flex:1; overflow-y:auto;"></div>
    </div>

    <!-- QUESTION DATA -->
    <script src="questions/sw/questions_beans.js"></script>
    <script src="questions/sw/questions_cashew.js"></script>
    <script src="questions/sw/questions_drought.js"></script>
    <script src="questions/sw/questions_maize.js"></script>
    <script src="questions/sw/questions_tomato.js"></script>

    <script>
        // ========== STATE ==========
        let userName = '';
        let sessionStart = null;
        let timerInterval = null;
        let currentModule = null;
        let currentLevel = 1;
        let currentLevelIndex = 0;
        let questions = [];
        let questionIndex = 0;
        let questionStart = null;
        let answers = [];
        let totalCorrect = 0;
        let levelCorrect = 0; // Correct answers in current level
        let levelTotal = 0;   // Total questions in current level
        const SESSION_DURATION = 5 * 60;
        const PASS_THRESHOLD = 80; // 80% required to unlock next level

        // Progress tracking - which levels are unlocked
        let unlockedIndex = 0; // Index into LEVELS array

        const LEVELS = [
            { module: 'beans', level: 1, name: 'Maharagwe', icon: 'ü´ò', color: '#f59e0b' },
            { module: 'beans', level: 2, name: 'Maharagwe', icon: 'ü´ò', color: '#f59e0b' },
            { module: 'beans', level: 3, name: 'Maharagwe', icon: 'ü´ò', color: '#f59e0b' },
            { module: 'cashew', level: 1, name: 'Korosho', icon: 'ü•ú', color: '#eab308' },
            { module: 'cashew', level: 2, name: 'Korosho', icon: 'ü•ú', color: '#eab308' },
            { module: 'cashew', level: 3, name: 'Korosho', icon: 'ü•ú', color: '#eab308' },
            { module: 'drought', level: 1, name: 'Ukame', icon: 'üèúÔ∏è', color: '#f97316' },
            { module: 'drought', level: 2, name: 'Ukame', icon: 'üèúÔ∏è', color: '#f97316' },
            { module: 'drought', level: 3, name: 'Ukame', icon: 'üèúÔ∏è', color: '#f97316' },
            { module: 'maize', level: 1, name: 'Mahindi', icon: 'üåΩ', color: '#facc15' },
            { module: 'maize', level: 2, name: 'Mahindi', icon: 'üåΩ', color: '#facc15' },
            { module: 'maize', level: 3, name: 'Mahindi', icon: 'üåΩ', color: '#facc15' },
            { module: 'tomato', level: 1, name: 'Nyanya', icon: 'üçÖ', color: '#ef4444' },
            { module: 'tomato', level: 2, name: 'Nyanya', icon: 'üçÖ', color: '#ef4444' },
            { module: 'tomato', level: 3, name: 'Nyanya', icon: 'üçÖ', color: '#ef4444' }
        ];

        // ========== HELPERS ==========
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return m + ':' + (s < 10 ? '0' : '') + s;
        }

        function getParticipants() {
            try { return JSON.parse(localStorage.getItem('farmlinguo_participants') || '[]'); }
            catch(e) { return []; }
        }

        function saveParticipants(list) {
            localStorage.setItem('farmlinguo_participants', JSON.stringify(list));
        }

        function updateParticipantCount() {
            document.getElementById('participantCount').textContent = getParticipants().length;
        }

        // ========== RENDER MODULES ==========
        function renderModules() {
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '';

            LEVELS.forEach((lvl, idx) => {
                const isCompleted = idx < unlockedIndex;
                const isUnlocked = idx === unlockedIndex;
                const isLocked = idx > unlockedIndex;

                const btn = document.createElement('button');
                btn.className = 'btn module-btn';

                if (isCompleted) {
                    btn.classList.add('completed');
                    btn.style.background = 'linear-gradient(135deg, #16a34a, #15803d)';
                } else if (isUnlocked) {
                    btn.style.background = `linear-gradient(135deg, ${lvl.color}, ${lvl.color}dd)`;
                } else {
                    btn.classList.add('locked');
                }

                const statusText = isCompleted ? '‚úì Imekamilika' : isUnlocked ? '‚ñ∂ Bofya kuanza' : 'üîí Imefungwa';

                btn.innerHTML = `
                    <span style="font-size:36px;">${lvl.icon}</span>
                    <div style="flex:1;">
                        <div style="font-size:20px;">${lvl.name} - L${lvl.level}</div>
                        <div style="font-size:14px;opacity:0.8;">${statusText}</div>
                    </div>
                `;

                if (isUnlocked) {
                    btn.onclick = () => startLevel(idx);
                } else if (isCompleted) {
                    btn.onclick = () => startLevel(idx); // Allow replay
                }

                container.appendChild(btn);
            });

            // Update level progress bar
            const progressPercent = (unlockedIndex / LEVELS.length) * 100;
            document.getElementById('levelProgress').style.width = progressPercent + '%';
            document.getElementById('levelProgressText').textContent = unlockedIndex + '/' + LEVELS.length;

            // If all completed, show congratulations
            if (unlockedIndex >= LEVELS.length) {
                const msg = document.createElement('div');
                msg.style.cssText = 'text-align:center; padding:20px; color:#58cc02; font-size:20px; font-weight:bold;';
                msg.innerHTML = 'üéâ Hongera! Umekamilisha viwango vyote!';
                container.appendChild(msg);
            }
        }

        function startLevel(idx) {
            const lvl = LEVELS[idx];
            currentModule = lvl.module;
            currentLevel = lvl.level;
            currentLevelIndex = idx;
            levelCorrect = 0;
            levelTotal = 0;
            loadLevel();
        }

        // ========== TIMER ==========
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
            const remaining = Math.max(0, SESSION_DURATION - elapsed);

            document.getElementById('timerDisplay').textContent = formatTime(remaining);
            document.getElementById('quizTimer').textContent = formatTime(remaining);
            document.getElementById('timeProgress').style.width = (elapsed / SESSION_DURATION * 100) + '%';

            if (remaining <= 60) {
                document.getElementById('timerDisplay').style.color = '#fca5a5';
            }

            if (remaining <= 0) {
                endTest();
            }
        }

        // ========== START TEST ==========
        function startTest() {
            userName = document.getElementById('nameInput').value.trim();
            const nameError = document.getElementById('nameError');
            const nameInput = document.getElementById('nameInput');

            if (!userName || userName.length < 2) {
                nameError.style.display = 'block';
                nameInput.style.borderColor = '#ff4b4b';
                nameInput.focus();
                return;
            }
            nameError.style.display = 'none';
            nameInput.style.borderColor = '#58cc02';

            sessionStart = Date.now();
            answers = [];
            totalCorrect = 0;
            unlockedIndex = 0; // Reset progress

            document.getElementById('displayName').textContent = userName;
            document.getElementById('answeredCount').textContent = '0';

            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();

            renderModules(); // Render level buttons
            showScreen('modulesScreen');
        }

        // ========== MODULE ==========
        function loadLevel() {
            const moduleData = {
                'beans': window.beansQuestions,
                'cashew': window.cashewQuestions,
                'drought': window.droughtQuestions,
                'maize': window.maizeQuestions,
                'tomato': window.tomatoQuestions
            };

            const icons = { 'beans': 'ü´ò', 'cashew': 'ü•ú', 'drought': 'üèúÔ∏è', 'maize': 'üåΩ', 'tomato': 'üçÖ' };

            const data = moduleData[currentModule];
            const levelKey = currentModule + '_level' + currentLevel;
            questions = data[levelKey] || [];

            if (questions.length === 0) {
                renderModules();
                showScreen('modulesScreen');
                return;
            }

            levelTotal = questions.length;
            questionIndex = 0;
            document.getElementById('moduleIcon').textContent = icons[currentModule];
            document.getElementById('questionIcon').textContent = icons[currentModule];
            document.getElementById('levelNum').textContent = currentLevel;

            showQuestion();
            showScreen('quizScreen');
        }

        // ========== QUIZ ==========
        let shuffledOptions = [];

        function shuffleArray(arr) {
            const shuffled = [...arr];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showQuestion() {
            const q = questions[questionIndex];
            document.getElementById('questionText').textContent = q.question;
            document.getElementById('questionProgress').style.width = ((questionIndex + 1) / questions.length * 100) + '%';

            // Hide feedback overlay and panel
            document.getElementById('feedbackOverlay').style.display = 'none';
            document.getElementById('feedbackPanel').style.display = 'none';

            const container = document.getElementById('answersContainer');
            container.innerHTML = '';

            // Shuffle options so correct answer isn't always first
            shuffledOptions = shuffleArray(q.options);

            shuffledOptions.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-answer';
                btn.innerHTML = (opt.icon ? '<span style="font-size:24px;">' + opt.icon + '</span>' : '') +
                    '<span style="flex:1;">' + opt.text + '</span>';
                btn.onclick = () => selectAnswer(i);
                container.appendChild(btn);
            });

            questionStart = Date.now();
        }

        function selectAnswer(index) {
            const q = questions[questionIndex];
            const selectedOpt = shuffledOptions[index];
            const isCorrect = selectedOpt.isCorrect;
            const responseTime = Date.now() - questionStart;

            // Record answer with full scientific data
            answers.push({
                // Identifikace
                answerId: answers.length + 1,
                timestamp: new Date().toISOString(),
                sessionTimeMs: Date.now() - sessionStart,

                // Modul a level
                module: currentModule,
                moduleName: LEVELS[currentLevelIndex].name,
                level: currentLevel,
                levelIndex: currentLevelIndex,

                // Ot√°zka
                questionIndex: questionIndex + 1,
                questionTotal: questions.length,
                questionText: q.question,

                // Odpovƒõƒè
                selectedAnswer: selectedOpt.text,
                selectedIndex: index,
                correctAnswer: shuffledOptions.find(o => o.isCorrect).text,
                correctIndex: shuffledOptions.findIndex(o => o.isCorrect),
                isCorrect: isCorrect,

                // ƒåas odpovƒõdi
                responseTimeMs: responseTime,
                responseTimeSec: Math.round(responseTime / 100) / 10,

                // V≈°echny mo≈ænosti (pro anal√Ωzu)
                allOptions: shuffledOptions.map(o => o.text),

                // Vysvƒõtlen√≠
                explanation: q.explanation || ''
            });

            if (isCorrect) {
                totalCorrect++;
                levelCorrect++;
            }
            document.getElementById('answeredCount').textContent = answers.length;

            // SAVE AFTER EVERY ANSWER - for research data integrity
            saveProgress();
            console.log('üìä Answer logged:', answers[answers.length - 1]);

            // Show feedback
            const btns = document.querySelectorAll('#answersContainer .btn-answer');
            btns.forEach((btn, i) => {
                btn.disabled = true;
                if (shuffledOptions[i].isCorrect) btn.classList.add('correct');
                else if (i === index) btn.classList.add('wrong');
            });

            // Show overlay and panel
            document.getElementById('feedbackOverlay').style.display = 'block';
            const panel = document.getElementById('feedbackPanel');
            panel.style.display = 'block';
            panel.style.background = isCorrect ? '#d7ffb8' : '#ffdfe0';
            document.getElementById('feedbackIcon').textContent = isCorrect ? 'üéâ' : 'üò¢';
            document.getElementById('feedbackTitle').textContent = isCorrect ? 'Vizuri sana!' : 'Si sawa kabisa';
            document.getElementById('feedbackTitle').style.color = isCorrect ? '#58cc02' : '#ff4b4b';
            document.getElementById('feedbackText').textContent = q.explanation || '';

            const continueBtn = document.getElementById('continueBtn');
            continueBtn.style.background = isCorrect ? '#58cc02' : '#ff4b4b';
            continueBtn.style.borderBottomColor = isCorrect ? '#58a700' : '#ea2b2b';
        }

        function nextQuestion() {
            questionIndex++;
            if (questionIndex >= questions.length) {
                // Level complete - show results
                showLevelComplete();
            } else {
                showQuestion();
            }
        }

        function showLevelComplete() {
            // Hide feedback overlay
            document.getElementById('feedbackOverlay').style.display = 'none';
            document.getElementById('feedbackPanel').style.display = 'none';

            const percent = Math.round(levelCorrect / levelTotal * 100);
            const passed = percent >= PASS_THRESHOLD;
            const needed = Math.ceil(levelTotal * PASS_THRESHOLD / 100);
            const missing = needed - levelCorrect;

            const lvl = LEVELS[currentLevelIndex];
            const header = document.getElementById('levelCompleteHeader');

            if (passed) {
                // SUCCESS - green screen
                header.style.background = '#58cc02';
                document.getElementById('levelEmoji').textContent = 'üéâ';
                document.getElementById('levelTitle').textContent = 'Hongera! Umefaulu!';
                document.getElementById('levelMessage').innerHTML =
                    '<div style="color:#16a34a; font-size:18px; font-weight:bold;">‚úì Umepita kiwango hiki!</div>' +
                    '<div style="color:#666; margin-top:8px;">Kiwango kifuatacho kimefunguliwa.</div>';

                // Unlock next level
                if (currentLevelIndex >= unlockedIndex) {
                    unlockedIndex = currentLevelIndex + 1;
                }

                // Show continue button
                document.getElementById('continueBtn2').style.display = 'block';
                document.getElementById('repeatBtn').style.display = 'none';
            } else {
                // FAIL - orange/red screen
                header.style.background = '#dc2626';
                document.getElementById('levelEmoji').textContent = 'üò¢';
                document.getElementById('levelTitle').textContent = 'Hukufaulu';
                document.getElementById('levelMessage').innerHTML =
                    '<div style="color:#dc2626; font-size:18px; font-weight:bold;">‚úó Unahitaji ' + PASS_THRESHOLD + '% kufungua kiwango kifuatacho</div>' +
                    '<div style="color:#666; margin-top:8px;">Ulikuwa na ' + levelCorrect + '/' + levelTotal + '. Ulihitaji angalau ' + needed + ' sahihi.</div>' +
                    '<div style="color:#666; margin-top:4px;">Maswali ' + missing + ' zaidi sahihi yangehitajika.</div>';

                // Hide continue, show repeat
                document.getElementById('continueBtn2').style.display = 'none';
                document.getElementById('repeatBtn').style.display = 'block';
            }

            document.getElementById('levelPercent').textContent = percent + '%';
            document.getElementById('levelScore').textContent = levelCorrect + '/' + levelTotal + ' sahihi';

            // Auto-save progress after each level
            saveProgress();

            showScreen('levelCompleteScreen');
        }

        function saveProgress() {
            if (answers.length === 0) return;

            const duration = Math.floor((Date.now() - sessionStart) / 1000);
            const accuracy = answers.length > 0 ? Math.round(totalCorrect / answers.length * 100) : 0;
            const avgTime = answers.length > 0 ? Math.round(answers.reduce((a, b) => a + b.timeMs, 0) / answers.length / 1000 * 10) / 10 : 0;

            // Check if this session already exists (update instead of create new)
            const list = getParticipants();
            const sessionId = 'session_' + sessionStart;
            const existingIdx = list.findIndex(p => p.sessionId === sessionId);

            const participant = {
                id: Date.now(),
                sessionId: sessionId,
                name: userName,
                date: new Date().toISOString(),
                duration: duration,
                total: answers.length,
                correct: totalCorrect,
                accuracy: accuracy,
                avgTime: avgTime,
                levelsCompleted: unlockedIndex,
                answers: answers
            };

            if (existingIdx >= 0) {
                // Update existing session
                list[existingIdx] = participant;
            } else {
                // New session
                list.push(participant);
            }

            saveParticipants(list);
            updateParticipantCount();
        }

        function continueToNext() {
            // Go to next level
            if (currentLevelIndex + 1 < LEVELS.length) {
                startLevel(currentLevelIndex + 1);
            } else {
                // All levels done
                renderModules();
                showScreen('modulesScreen');
            }
        }

        function repeatLevel() {
            // Repeat current level
            startLevel(currentLevelIndex);
        }

        // ========== END TEST ==========
        function endTest() {
            clearInterval(timerInterval);

            // Save final progress
            saveProgress();

            const accuracy = answers.length > 0 ? Math.round(totalCorrect / answers.length * 100) : 0;
            const avgTime = answers.length > 0 ? Math.round(answers.reduce((a, b) => a + b.timeMs, 0) / answers.length / 1000 * 10) / 10 : 0;

            // Show results
            const header = document.getElementById('resultsHeader');
            header.style.background = accuracy >= 70 ? '#58cc02' : accuracy >= 50 ? '#ffc800' : '#ff4b4b';
            document.getElementById('resultEmoji').textContent = accuracy >= 70 ? 'üèÜ' : accuracy >= 50 ? '‚úÖ' : 'üí™';
            document.getElementById('resultPercent').textContent = accuracy + '%';
            document.getElementById('resultText').textContent = totalCorrect + '/' + answers.length + ' sahihi';
            document.getElementById('statQuestions').textContent = answers.length;
            document.getElementById('statCorrect').textContent = totalCorrect;
            document.getElementById('statTime').textContent = avgTime + 's';

            // Render answers log
            renderAnswersLog();

            showScreen('resultsScreen');
        }

        function renderAnswersLog() {
            const container = document.getElementById('answersLog');
            if (answers.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; padding:16px;">Hakuna majibu</p>';
                return;
            }

            container.innerHTML = answers.map((a, idx) => {
                const time = a.responseTimeSec || (a.responseTimeMs ? Math.round(a.responseTimeMs/100)/10 : (a.timeMs ? Math.round(a.timeMs/100)/10 : '?'));
                return `
                    <div class="log-item ${a.isCorrect ? 'correct' : 'wrong'}">
                        <span style="font-weight:bold; min-width:24px;">${idx + 1}.</span>
                        <span style="flex:1;">${a.moduleName || a.module} L${a.level}</span>
                        <span>${a.isCorrect ? '‚úì' : '‚úó'}</span>
                        <span style="color:#666; font-size:12px;">${time}s</span>
                    </div>
                `;
            }).join('');
        }

        // ========== PARTICIPANTS ==========
        function showParticipants() {
            const list = getParticipants();
            const container = document.getElementById('participantsList');

            if (list.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; padding:32px;">Hakuna washiriki bado</p>';
            } else {
                container.innerHTML = list.slice().reverse().map((p, idx) => {
                    const mins = Math.floor((p.duration || 0) / 60);
                    const secs = (p.duration || 0) % 60;
                    const timeStr = mins + ':' + (secs < 10 ? '0' : '') + secs;
                    const color = p.accuracy >= 70 ? '#58cc02' : p.accuracy >= 50 ? '#ffc800' : '#ff4b4b';
                    const pId = 'participant_' + idx;

                    // Create answers detail
                    let answersHtml = '';
                    if (p.answers && p.answers.length > 0) {
                        answersHtml = p.answers.map((a, aIdx) => {
                            const time = a.responseTimeSec || (a.responseTimeMs ? Math.round(a.responseTimeMs/100)/10 : (a.timeMs ? Math.round(a.timeMs/100)/10 : '?'));
                            return '<div class="log-item ' + (a.isCorrect ? 'correct' : 'wrong') + '">' +
                                '<span style="min-width:20px;">' + (aIdx + 1) + '.</span>' +
                                '<span style="flex:1;">' + (a.moduleName || a.module || '') + ' L' + (a.level || '') + '</span>' +
                                '<span>' + (a.isCorrect ? '‚úì' : '‚úó') + '</span>' +
                                '<span style="color:#666; font-size:11px;">' + time + 's</span>' +
                            '</div>';
                        }).join('');
                    } else {
                        answersHtml = '<p style="color:#888; text-align:center; padding:8px;">Hakuna majibu</p>';
                    }

                    return '<div class="participant" style="border-left-color:' + color + '; cursor:pointer; flex-direction:column; align-items:stretch;" onclick="toggleParticipant(\'' + pId + '\')">' +
                        '<div style="display:flex; justify-content:space-between; align-items:center;">' +
                            '<div style="flex:1;">' +
                                '<div style="font-weight:bold;">' + p.name + ' <span style="font-size:12px; color:#888;">‚ñº</span></div>' +
                                '<div style="font-size:12px; color:#888;">' + new Date(p.date).toLocaleDateString() + '</div>' +
                                '<div style="font-size:13px; margin-top:4px;">‚úÖ ' + (p.correct || 0) + '/' + (p.total || 0) + ' ‚Ä¢ ‚è±Ô∏è ' + timeStr + '</div>' +
                            '</div>' +
                            '<div style="text-align:right;">' +
                                '<div style="font-size:24px; font-weight:bold; color:' + color + '">' + (p.accuracy || 0) + '%</div>' +
                            '</div>' +
                        '</div>' +
                        '<div id="' + pId + '" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid #e5e7eb; max-height:200px; overflow-y:auto;">' +
                            answersHtml +
                        '</div>' +
                    '</div>';
                }).join('');
            }

            showScreen('participantsScreen');
        }

        function toggleParticipant(id) {
            const el = document.getElementById(id);
            if (el.style.display === 'none') {
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        }

        function exportJSON() {
            const data = { date: new Date().toISOString(), participants: getParticipants() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'farmlinguo_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
        }

        function exportCSV() {
            // Summary CSV
            let csv = 'participant_id,name,date,total_questions,correct_answers,accuracy_percent,avg_response_time_sec,session_duration_sec,levels_completed\n';
            getParticipants().forEach((p, idx) => {
                csv += idx + ',"' + p.name + '",' + p.date + ',' + p.total + ',' + p.correct + ',' + p.accuracy + ',' + p.avgTime + ',' + p.duration + ',' + (p.levelsCompleted || 0) + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'farmlinguo_summary_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        function exportDetailedCSV() {
            // Detailed CSV with all answers for scientific analysis
            let csv = 'participant_id,participant_name,answer_id,timestamp,session_time_ms,module,module_name,level,question_index,question_total,question_text,selected_answer,correct_answer,is_correct,response_time_ms,response_time_sec\n';

            getParticipants().forEach((p, pIdx) => {
                if (p.answers && p.answers.length > 0) {
                    p.answers.forEach(a => {
                        csv += pIdx + ',"' + p.name + '",' +
                            (a.answerId || '') + ',' +
                            (a.timestamp || '') + ',' +
                            (a.sessionTimeMs || '') + ',' +
                            (a.module || '') + ',' +
                            '"' + (a.moduleName || '') + '",' +
                            (a.level || '') + ',' +
                            (a.questionIndex || '') + ',' +
                            (a.questionTotal || '') + ',' +
                            '"' + (a.questionText || a.question || '').replace(/"/g, '""') + '",' +
                            '"' + (a.selectedAnswer || a.selected || '').replace(/"/g, '""') + '",' +
                            '"' + (a.correctAnswer || a.correct || '').replace(/"/g, '""') + '",' +
                            (a.isCorrect ? 1 : 0) + ',' +
                            (a.responseTimeMs || a.timeMs || '') + ',' +
                            (a.responseTimeSec || (a.timeMs ? Math.round(a.timeMs/100)/10 : '')) + '\n';
                    });
                }
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'farmlinguo_detailed_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        function clearData() {
            if (confirm('Una uhakika unataka kufuta data yote?')) {
                localStorage.removeItem('farmlinguo_participants');
                updateParticipantCount();
                showParticipants();
            }
        }

        // ========== INIT ==========
        updateParticipantCount();
    </script>
</body>
</html>
